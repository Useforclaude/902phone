<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบติดตามการขายเบอร์ 2-Phase | 920 เบอร์</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #fff;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .phase-indicator {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .phase-badge {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .phase-1 { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .phase-2 { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #fff;
        }

        .partner-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .partner-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .partner-card:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .partner-name {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
            cursor: pointer;
            transition: color 0.3s;
        }

        .partner-name:hover {
            color: #ffd700;
        }

        .partner-status {
            font-size: 0.85rem;
            padding: 5px 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 20px;
            margin-bottom: 15px;
            display: inline-block;
        }

        .partner-amounts {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        .amount-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .amount-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .amount-value {
            font-size: 1.1rem;
            font-weight: bold;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            overflow: hidden;
            margin-top: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .control-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        .tab {
            padding: 10px 20px;
            background: transparent;
            border: none;
            color: #fff;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s;
            border-radius: 10px 10px 0 0;
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .tab.active {
            background: rgba(255, 255, 255, 0.2);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            opacity: 0.9;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            font-size: 1rem;
            color: #333;
            transition: all 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
            transform: scale(1.02);
        }

        button {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-success {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
        }

        .history-table {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            overflow: hidden;
            margin-top: 20px;
        }

        .history-table thead {
            background: rgba(255, 255, 255, 0.1);
        }

        .history-table th, .history-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .history-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 0.9rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            animation: fadeIn 0.3s;
        }

        .modal-content {
            position: relative;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 50px auto;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            border-radius: 20px;
            animation: slideDown 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .close-modal {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 2rem;
            cursor: pointer;
            color: #fff;
            transition: transform 0.3s;
        }

        .close-modal:hover {
            transform: rotate(90deg);
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: rgba(76, 175, 80, 0.9);
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s;
            z-index: 2000;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(0);
            }
        }

        .toast.error {
            background: rgba(244, 67, 54, 0.9);
        }

        .toast.warning {
            background: rgba(255, 152, 0, 0.9);
        }

        /* Print Styles - ปรับปรุงใหม่ให้สวยงาม */
        @media print {
            @page {
                size: A4 landscape;
                margin: 15mm;
            }
            
            body {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color: white !important;
            }
            
            .container {
                max-width: 100%;
            }
            
            .control-panel, .tabs, button:not(.btn-print), .action-buttons {
                display: none !important;
            }
            
            .header {
                background: rgba(102, 126, 234, 0.15) !important;
                border: 2px solid #667eea !important;
                page-break-inside: avoid;
                margin-bottom: 30px !important;
            }
            
            .stat-card, .partner-card {
                background: rgba(255, 255, 255, 0.95) !important;
                color: #333 !important;
                border: 2px solid #667eea !important;
                break-inside: avoid;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1) !important;
            }

            .stat-value, .amount-value {
                color: #000002 !important;
                font-weight: bold !important;
            }

            .partner-name span {
                color: #764ba2 !important;
            }
            
            .history-table {
                background: white !important;
                color: #333 !important;
                border: 2px solid #667eea !important;
                margin-top: 30px !important;
                page-break-inside: auto;
            }
            
            .history-table thead {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
                color: white !important;
            }
            
            .history-table th {
                color: white !important;
                font-weight: bold !important;
                border-bottom: 2px solid #667eea !important;
                padding: 12px 8px !important;
                font-size: 0.9rem !important;
            }
            
            .history-table td {
                color: #333 !important;
                border-bottom: 1px solid #e0e0e0 !important;
                padding: 10px 8px !important;
                font-size: 0.85rem !important;
            }

            .history-table tbody tr:nth-child(even) {
                background: rgba(102, 126, 234, 0.05) !important;
            }

            .phase-badge {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
                color: white !important;
                padding: 10px 20px !important;
                border-radius: 25px !important;
            }

            .capital-return-progress {
                background: rgba(255, 255, 255, 0.95) !important;
                color: #333 !important;
                border: 2px solid #667eea !important;
                padding: 20px !important;
            }

            .progress-bar {
                background: #e0e0e0 !important;
                border: 1px solid #667eea !important;
            }

            .progress-fill {
                background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%) !important;
                color: white !important;
            }

            /* เพิ่ม header สำหรับการพิมพ์ */
            .print-header {
                display: block !important;
                text-align: center;
                margin-bottom: 30px;
                padding: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
                color: white !important;
                border-radius: 15px;
            }

            .print-header h2 {
                font-size: 24px;
                margin-bottom: 10px;
            }

            .print-date {
                font-size: 14px;
                opacity: 0.9;
            }
        }

        .capital-return-progress {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
        }

        .summary-section {
            margin-top: 30px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Print header - ซ่อนไว้ตอนปกติ */
        .print-header {
            display: none;
        }

        /* Modal styles for edit sale */
        .modal-form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Print Header - แสดงเฉพาะตอนพิมพ์ -->
        <div class="print-header">
            <h2>📊 ประวัติการขายเบอร์ในแต่ละวัน</h2>
            <div class="print-date">พิมพ์เมื่อ: <span id="printDate"></span></div>
        </div>

        <!-- Header -->
        <div class="header">
            <div class="phase-indicator">
                <h1>📱 ระบบติดตามการขายเบอร์ (920 เบอร์)</h1>
                <div id="phaseIndicator" class="phase-badge phase-1">
                    <span>📊</span>
                    <span id="phaseText">Phase 1: คืนทุน A</span>
                </div>
            </div>

            <!-- Stats Overview -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">เบอร์ทั้งหมด</div>
                    <div class="stat-value">920 เบอร์</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ขายแล้ว</div>
                    <div class="stat-value" id="soldCount">0 เบอร์</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">คงเหลือ</div>
                    <div class="stat-value" id="remainingCount">920 เบอร์</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ความคืบหน้า</div>
                    <div class="stat-value" id="progressPercent">0%</div>
                </div>
            </div>

            <!-- Capital Return Progress (Phase 1 Only) -->
            <div id="capitalProgress" class="capital-return-progress">
                <h3 style="margin-bottom: 15px;">💰 ความคืบหน้าการคืนทุน A</h3>
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>เงินต้น A (70%): <strong id="aCapitalAmount">0</strong> บาท</span>
                    <span>คืนแล้ว: <strong id="aReturnedAmount">0</strong> บาท</span>
                </div>
                <div class="progress-bar">
                    <div id="capitalProgressBar" class="progress-fill" style="width: 0%">0%</div>
                </div>
            </div>

            <!-- Partner Cards -->
            <div class="partner-cards">
                <div class="partner-card">
                    <div class="partner-name" onclick="editPartnerName('A')">
                        <span id="nameA">Pan</span> ✏️
                    </div>
                    <div id="statusA" class="partner-status">Phase 1: 70%</div>
                    <div class="partner-amounts">
                        <div class="amount-row">
                            <span class="amount-label">ลงทุน:</span>
                            <span class="amount-value" id="investedA">0 ฿</span>
                        </div>
                        <div class="amount-row">
                            <span class="amount-label">ได้รับ:</span>
                            <span class="amount-value" id="receivedA">0 ฿</span>
                        </div>
                        <div class="amount-row">
                            <span class="amount-label">กำไร:</span>
                            <span class="amount-value" id="profitA">0 ฿</span>
                        </div>
                    </div>
                </div>

                <div class="partner-card">
                    <div class="partner-name" onclick="editPartnerName('B')">
                        <span id="nameB">Yam</span> ✏️
                    </div>
                    <div id="statusB" class="partner-status">Phase 1: 30%</div>
                    <div class="partner-amounts">
                        <div class="amount-row">
                            <span class="amount-label">ลงทุน:</span>
                            <span class="amount-value" id="investedB">0 ฿</span>
                        </div>
                        <div class="amount-row">
                            <span class="amount-label">ได้รับ:</span>
                            <span class="amount-value" id="receivedB">0 ฿</span>
                        </div>
                        <div class="amount-row">
                            <span class="amount-label">กำไร:</span>
                            <span class="amount-value" id="profitB">0 ฿</span>
                        </div>
                    </div>
                </div>

                <div class="partner-card">
                    <div class="partner-name" onclick="editPartnerName('C')">
                        <span id="nameC">Pong</span> ✏️
                    </div>
                    <div id="statusC" class="partner-status">รอ Phase 2</div>
                    <div class="partner-amounts">
                        <div class="amount-row">
                            <span class="amount-label">ลงทุน:</span>
                            <span class="amount-value" id="investedC">0 ฿</span>
                        </div>
                        <div class="amount-row">
                            <span class="amount-label">ได้รับ:</span>
                            <span class="amount-value" id="receivedC">0 ฿</span>
                        </div>
                        <div class="amount-row">
                            <span class="amount-label">กำไร:</span>
                            <span class="amount-value" id="profitC">0 ฿</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="control-panel">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('sale')">📊 บันทึกการขาย</button>
                <button class="tab" onclick="switchTab('settings')">⚙️ ตั้งค่าระบบ</button>
                <button class="tab" onclick="switchTab('history')">📜 ประวัติ</button>
                <button class="tab" onclick="switchTab('backup')">💾 Backup/Restore</button>
            </div>

            <!-- Sale Tab -->
            <div id="saleTab" class="tab-content active">
                <h3 style="margin-bottom: 20px;">บันทึกการขายประจำวัน</h3>
                <form id="saleForm" onsubmit="addSale(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>วันที่</label>
                            <input type="date" id="saleDate" required>
                        </div>
                        <div class="form-group">
                            <label>จำนวนเบอร์ที่ขาย</label>
                            <input type="number" id="numberCount" min="1" placeholder="เช่น 5" required>
                        </div>
                    </div>
                    
                    <!-- แยกช่องทางการขาย -->
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h4 style="margin-bottom: 15px; color: #ffd700;">💰 ยอดขายแยกตามช่องทาง</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>🔵 ช่องทาง <span id="channelNameA">Pan</span> (บาท)</label>
                                <input type="number" id="salesChannelA" min="0" step="0.01" placeholder="0" value="0" onchange="calculateTotal()">
                            </div>
                            <div class="form-group">
                                <label>🟢 ช่องทาง <span id="channelNameB">Yam</span> (บาท)</label>
                                <input type="number" id="salesChannelB" min="0" step="0.01" placeholder="0" value="0" onchange="calculateTotal()">
                            </div>
                            <div class="form-group">
                                <label>📊 ยอดขายรวมทั้งหมด (บาท)</label>
                                <input type="number" id="totalAmount" min="0" step="0.01" readonly style="background: rgba(255, 255, 255, 0.7); font-weight: bold; color: #667eea;">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>หมายเหตุ (ถ้ามี)</label>
                        <textarea id="saleNote" rows="2" placeholder="รายละเอียดเพิ่มเติม..."></textarea>
                    </div>
                    <button type="submit" class="btn-success">💾 บันทึกการขาย</button>
                </form>
            </div>

            <!-- Settings Tab -->
            <div id="settingsTab" class="tab-content">
                <h3 style="margin-bottom: 20px;">ตั้งค่าเงินลงทุนและต้นทุน</h3>
                <form id="settingsForm" onsubmit="saveSettings(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>เงินลงทุนรวม (บาท)</label>
                            <input type="number" id="totalInvestment" min="0" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>ต้นทุนเฉลี่ยต่อเบอร์ (บาท)</label>
                            <input type="number" id="avgCost" min="0" step="0.01" required>
                        </div>
                    </div>
                    <button type="submit" class="btn-warning">💾 บันทึกการตั้งค่า</button>
                </form>
            </div>

            <!-- History Tab -->
            <div id="historyTab" class="tab-content">
                <h3 style="margin-bottom: 20px;">ประวัติการขาย</h3>
                <div style="margin-bottom: 20px;">
                    <button onclick="printReport()" class="btn-success">🖨️ พิมพ์รายงาน PDF</button>
                    <button onclick="exportCSV()" class="btn-warning">📊 Export CSV</button>
                </div>
                <table class="history-table" id="historyTable">
                    <thead id="historyHead">
                        <!-- Dynamic headers will be inserted here -->
                    </thead>
                    <tbody id="historyBody">
                        <tr>
                            <td colspan="8" style="text-align: center; opacity: 0.5;">ยังไม่มีประวัติการขาย</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Backup Tab -->
            <div id="backupTab" class="tab-content">
                <h3 style="margin-bottom: 20px;">Backup & Restore ข้อมูล</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <div>
                        <h4 style="margin-bottom: 15px;">💾 Backup ข้อมูล</h4>
                        <div class="form-group">
                            <label>ชื่อไฟล์</label>
                            <input type="text" id="backupFileName" placeholder="phone-auction-backup" value="phone-auction-backup">
                        </div>
                        <button onclick="backupData()" class="btn-success">📥 Download Backup</button>
                    </div>
                    <div>
                        <h4 style="margin-bottom: 15px;">📂 Restore ข้อมูล</h4>
                        <div class="form-group">
                            <label>เลือกไฟล์ Backup</label>
                            <input type="file" id="restoreFile" accept=".json">
                        </div>
                        <button onclick="restoreData()" class="btn-warning">📤 Restore Data</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Section -->
        <div class="summary-section">
            <h3 style="margin-bottom: 20px;">📈 สรุปผลประกอบการ</h3>
            <div class="summary-grid">
                <div>
                    <div class="stat-label">รายได้รวม</div>
                    <div class="stat-value" id="totalRevenue">0 ฿</div>
                </div>
                <div>
                    <div class="stat-label">ต้นทุนรวม</div>
                    <div class="stat-value" id="totalCost">0 ฿</div>
                </div>
                <div>
                    <div class="stat-label">กำไรรวม</div>
                    <div class="stat-value" id="totalProfit">0 ฿</div>
                </div>
                <div>
                    <div class="stat-label">ราคาขายเฉลี่ย</div>
                    <div class="stat-value" id="avgSalePrice">0 ฿</div>
                </div>
            </div>
            
            <!-- Phase Summary -->
            <div id="phaseSummary" style="margin-top: 30px; padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 15px;">
                <h4 style="margin-bottom: 15px;">📊 สรุปแยกตาม Phase</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h5 style="color: #f093fb; margin-bottom: 10px;">Phase 1: คืนทุน</h5>
                        <div style="font-size: 0.9rem; opacity: 0.9;">
                            <div>• Pan: 70% (คืนทุน)</div>
                            <div>• Yam: 30%</div>
                            <div>• Pong: รอ Phase 2</div>
                        </div>
                    </div>
                    <div>
                        <h5 style="color: #4facfe; margin-bottom: 10px;">Phase 2: แบ่งกำไร</h5>
                        <div style="font-size: 0.9rem; opacity: 0.9;">
                            <div>• Pan: 50%</div>
                            <div>• Yam: 30%</div>
                            <div>• Pong: 20%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <h3 id="modalTitle">แก้ไขข้อมูล</h3>
            <form id="editForm" onsubmit="saveEdit(event)">
                <div id="modalBody">
                    <!-- Dynamic content based on edit type -->
                </div>
                <div style="margin-top: 20px;">
                    <button type="submit" class="btn-success">บันทึก</button>
                    <button type="button" onclick="closeModal()" class="btn-danger">ยกเลิก</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast" style="display: none;"></div>

    <script>
        // Application State
        let appState = {
            phase: 1,
            totalNumbers: 920,
            sales: [],
            settings: {
                totalInvestment: 0,
                avgCost: 0,
                aCapitalAmount: 0,
                aCapitalReturned: 0
            },
            partners: {
                A: { name: 'Pan', invested: 0, received: 0 },
                B: { name: 'Yam', invested: 0, received: 0 },
                C: { name: 'Pong', invested: 0, received: 0 }
            }
        };

        // Calculate total from channels
        function calculateTotal() {
            const channelA = parseFloat(document.getElementById('salesChannelA').value) || 0;
            const channelB = parseFloat(document.getElementById('salesChannelB').value) || 0;
            const total = channelA + channelB;
            document.getElementById('totalAmount').value = total;
        }

        // Update channel names in form
        function updateChannelNames() {
            const channelNameA = document.getElementById('channelNameA');
            const channelNameB = document.getElementById('channelNameB');
            if (channelNameA) channelNameA.textContent = appState.partners.A.name;
            if (channelNameB) channelNameB.textContent = appState.partners.B.name;
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            setTodayDate();
            updateDashboard();
            updateHistoryHeaders();
            updateSummary();
            updateChannelNames(); // อัพเดทชื่อช่องทาง
        });

        // Set today's date as default
        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('saleDate').value = today;
        }

        // Switch tabs
        function switchTab(tabName) {
            // Remove active class from all tabs and contents
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to selected tab
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Update history if switching to history tab
            if (tabName === 'history') {
                updateHistory();
                updateHistoryHeaders(); // อัพเดท headers
            }
        }

        // Update history table headers based on phase
        function updateHistoryHeaders() {
            const thead = document.getElementById('historyHead');
            
            // Check current phase (determined by latest sales or settings)
            const currentPhase = appState.sales.length > 0 ? 
                appState.sales[appState.sales.length - 1].phase : appState.phase;
            
            let headers = '';
            
            if (currentPhase === 1 || appState.sales.some(s => s.phase === 1)) {
                // Phase 1 headers
                headers = `
                    <tr>
                        <th>วันที่</th>
                        <th>จำนวนเบอร์</th>
                        <th>ยอดขาย</th>
                        <th>${appState.partners.A.name} คืนทุน</th>
                        <th>${appState.partners.B.name} ได้รับ</th>
                        <th>Phase</th>
                        <th>การจัดการ</th>
                    </tr>
                `;
            }
            
            // If there are Phase 2 sales, show Phase 2 headers
            if (appState.sales.some(s => s.phase === 2)) {
                headers = `
                    <tr>
                        <th>วันที่</th>
                        <th>จำนวนเบอร์</th>
                        <th>ยอดขาย</th>
                        <th>${appState.partners.A.name} ได้รับ</th>
                        <th>${appState.partners.B.name} ได้รับ</th>
                        <th>${appState.partners.C.name} ได้รับ</th>
                        <th>Phase</th>
                        <th>การจัดการ</th>
                    </tr>
                `;
            }
            
            // Default if no sales yet
            if (!headers) {
                headers = `
                    <tr>
                        <th>วันที่</th>
                        <th>จำนวนเบอร์</th>
                        <th>ยอดขาย</th>
                        <th>${appState.partners.A.name} คืนทุน</th>
                        <th>${appState.partners.B.name} ได้รับ</th>
                        <th>Phase</th>
                        <th>การจัดการ</th>
                    </tr>
                `;
            }
            
            thead.innerHTML = headers;
        }

        // Add sale
        function addSale(event) {
            event.preventDefault();
            
            const channelA = parseFloat(document.getElementById('salesChannelA').value) || 0;
            const channelB = parseFloat(document.getElementById('salesChannelB').value) || 0;
            
            const sale = {
                id: Date.now(),
                date: document.getElementById('saleDate').value,
                numberCount: parseInt(document.getElementById('numberCount').value),
                salesChannelA: channelA,  // เก็บยอดขายช่องทาง A
                salesChannelB: channelB,  // เก็บยอดขายช่องทาง B
                totalAmount: channelA + channelB,  // ยอดรวม
                note: document.getElementById('saleNote').value,
                phase: appState.phase,
                timestamp: new Date().toISOString()
            };
            
            // Validate at least one channel has sales
            if (sale.totalAmount <= 0) {
                showToast('กรุณาใส่ยอดขายอย่างน้อย 1 ช่องทาง', 'error');
                return;
            }
            
            // Calculate costs and profit
            sale.totalCost = sale.numberCount * appState.settings.avgCost;
            sale.profit = sale.totalAmount - sale.totalCost;
            
            // Calculate sharing based on phase
            calculateSharing(sale);
            
            // Add to sales array
            appState.sales.push(sale);
            
            // Update state
            saveData();
            updateDashboard();
            
            // Reset form
            document.getElementById('saleForm').reset();
            document.getElementById('salesChannelA').value = 0;
            document.getElementById('salesChannelB').value = 0;
            document.getElementById('totalAmount').value = 0;
            setTodayDate();
            
            showToast(`บันทึกการขายสำเร็จ! (${appState.partners.A.name}: ${channelA.toLocaleString()}฿, ${appState.partners.B.name}: ${channelB.toLocaleString()}฿)`, 'success');
        }

        // Calculate profit sharing
        function calculateSharing(sale) {
            const revenue = sale.totalAmount;
            
            if (appState.phase === 1) {
                // Phase 1: A gets 70%, B gets 30%, C gets 0%
                const shareA = revenue * 0.7;
                const shareB = revenue * 0.3;
                
                appState.partners.A.received += shareA;
                appState.partners.B.received += shareB;
                
                // บันทึกจำนวนที่ A ได้คืนในแต่ละครั้ง
                const capitalBefore = appState.settings.aCapitalReturned;
                const actualReturn = Math.min(shareA, appState.settings.aCapitalAmount - capitalBefore);
                sale.aCapitalReturn = actualReturn; // จำนวนที่ A ได้คืนทุนในครั้งนี้
                
                // Update capital returned for A
                appState.settings.aCapitalReturned = Math.min(
                    appState.settings.aCapitalReturned + shareA,
                    appState.settings.aCapitalAmount
                );
                
                // Check if should switch to Phase 2
                if (appState.settings.aCapitalReturned >= appState.settings.aCapitalAmount && capitalBefore < appState.settings.aCapitalAmount) {
                    appState.phase = 2;
                    showToast('🎉 Phase 2 เริ่มแล้ว! ' + appState.partners.A.name + ' ได้รับเงินต้นครบแล้ว', 'success');
                }
                
                sale.shareA = shareA;
                sale.shareB = shareB;
                sale.shareC = 0;
            } else {
                // Phase 2: A gets 50%, B gets 30%, C gets 20%
                const shareA = revenue * 0.5;
                const shareB = revenue * 0.3;
                const shareC = revenue * 0.2;
                
                appState.partners.A.received += shareA;
                appState.partners.B.received += shareB;
                appState.partners.C.received += shareC;
                
                sale.shareA = shareA;
                sale.shareB = shareB;
                sale.shareC = shareC;
                sale.aCapitalReturn = 0; // Phase 2 ไม่มีการคืนทุน
            }
        }

        // Update dashboard
        function updateDashboard() {
            // Update phase indicator
            const phaseIndicator = document.getElementById('phaseIndicator');
            const phaseText = document.getElementById('phaseText');
            if (appState.phase === 1) {
                phaseIndicator.className = 'phase-badge phase-1';
                phaseText.textContent = 'Phase 1: คืนทุน ' + appState.partners.A.name;
                document.getElementById('capitalProgress').style.display = 'block';
            } else {
                phaseIndicator.className = 'phase-badge phase-2';
                phaseText.textContent = 'Phase 2: แบ่งกำไร 3 คน';
                document.getElementById('capitalProgress').style.display = 'none';
            }
            
            // Calculate totals
            const totalSold = appState.sales.reduce((sum, sale) => sum + sale.numberCount, 0);
            const remaining = appState.totalNumbers - totalSold;
            const progress = (totalSold / appState.totalNumbers * 100).toFixed(1);
            
            // Update stats
            document.getElementById('soldCount').textContent = `${totalSold} เบอร์`;
            document.getElementById('remainingCount').textContent = `${remaining} เบอร์`;
            document.getElementById('progressPercent').textContent = `${progress}%`;
            
            // Update capital progress (Phase 1)
            if (appState.phase === 1 || appState.settings.aCapitalReturned > 0) {
                const capitalPercent = appState.settings.aCapitalAmount > 0 ? 
                    (appState.settings.aCapitalReturned / appState.settings.aCapitalAmount * 100).toFixed(1) : 0;
                document.getElementById('aCapitalAmount').textContent = appState.settings.aCapitalAmount.toLocaleString();
                document.getElementById('aReturnedAmount').textContent = appState.settings.aCapitalReturned.toLocaleString();
                document.getElementById('capitalProgressBar').style.width = `${capitalPercent}%`;
                document.getElementById('capitalProgressBar').textContent = `${capitalPercent}%`;
            }
            
            // Update partner cards
            updatePartnerCards();
            
            // Update summary
            updateSummary();
            
            // Update history headers
            updateHistoryHeaders();
        }

        // Update partner cards
        function updatePartnerCards() {
            const partners = ['A', 'B', 'C'];
            
            partners.forEach(partner => {
                const data = appState.partners[partner];
                const profit = data.received - data.invested;
                
                document.getElementById(`name${partner}`).textContent = data.name;
                document.getElementById(`invested${partner}`).textContent = data.invested.toLocaleString() + ' ฿';
                document.getElementById(`received${partner}`).textContent = data.received.toLocaleString() + ' ฿';
                document.getElementById(`profit${partner}`).textContent = 
                    (profit >= 0 ? '' : '-') + Math.abs(profit).toLocaleString() + ' ฿';
                
                // Update status
                const statusEl = document.getElementById(`status${partner}`);
                if (appState.phase === 1) {
                    if (partner === 'A') statusEl.textContent = 'Phase 1: 70%';
                    else if (partner === 'B') statusEl.textContent = 'Phase 1: 30%';
                    else statusEl.textContent = 'รอ Phase 2';
                } else {
                    if (partner === 'A') statusEl.textContent = 'Phase 2: 50%';
                    else if (partner === 'B') statusEl.textContent = 'Phase 2: 30%';
                    else statusEl.textContent = 'Phase 2: 20%';
                }
            });
        }

        // Update summary
        function updateSummary() {
            const totalRevenue = appState.sales.reduce((sum, sale) => sum + sale.totalAmount, 0);
            const totalCost = appState.sales.reduce((sum, sale) => sum + sale.totalCost, 0);
            const totalProfit = totalRevenue - totalCost;
            const totalSold = appState.sales.reduce((sum, sale) => sum + sale.numberCount, 0);
            const avgPrice = totalSold > 0 ? totalRevenue / totalSold : 0;
            
            document.getElementById('totalRevenue').textContent = totalRevenue.toLocaleString() + ' ฿';
            document.getElementById('totalCost').textContent = totalCost.toLocaleString() + ' ฿';
            document.getElementById('totalProfit').textContent = totalProfit.toLocaleString() + ' ฿';
            document.getElementById('avgSalePrice').textContent = Math.round(avgPrice).toLocaleString() + ' ฿';
            
            // Update phase summary with dynamic names
            const phaseSummary = document.getElementById('phaseSummary');
            if (phaseSummary) {
                phaseSummary.innerHTML = `
                    <h4 style="margin-bottom: 15px;">📊 สรุปแยกตาม Phase</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h5 style="color: #f093fb; margin-bottom: 10px;">Phase 1: คืนทุน</h5>
                            <div style="font-size: 0.9rem; opacity: 0.9;">
                                <div>• ${appState.partners.A.name}: 70% (คืนทุน)</div>
                                <div>• ${appState.partners.B.name}: 30%</div>
                                <div>• ${appState.partners.C.name}: รอ Phase 2</div>
                            </div>
                        </div>
                        <div>
                            <h5 style="color: #4facfe; margin-bottom: 10px;">Phase 2: แบ่งกำไร</h5>
                            <div style="font-size: 0.9rem; opacity: 0.9;">
                                <div>• ${appState.partners.A.name}: 50%</div>
                                <div>• ${appState.partners.B.name}: 30%</div>
                                <div>• ${appState.partners.C.name}: 20%</div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Update history table
        function updateHistory() {
            const tbody = document.getElementById('historyBody');
            
            if (appState.sales.length === 0) {
                const colspan = appState.phase === 2 ? 8 : 7;
                tbody.innerHTML = `<tr><td colspan="${colspan}" style="text-align: center; opacity: 0.5;">ยังไม่มีประวัติการขาย</td></tr>`;
                return;
            }
            
            // Check if we need mixed display (both Phase 1 and Phase 2)
            const hasPhase1 = appState.sales.some(s => s.phase === 1);
            const hasPhase2 = appState.sales.some(s => s.phase === 2);
            
            tbody.innerHTML = appState.sales.map(sale => {
                let rowContent = '';
                
                // Format sales amount with channel breakdown
                let salesDisplay = `${sale.totalAmount.toLocaleString()} ฿`;
                if (sale.salesChannelA !== undefined && sale.salesChannelB !== undefined) {
                    const channelADisplay = sale.salesChannelA > 0 ? `🔵 ${sale.salesChannelA.toLocaleString()}` : '';
                    const channelBDisplay = sale.salesChannelB > 0 ? `🟢 ${sale.salesChannelB.toLocaleString()}` : '';
                    const channels = [channelADisplay, channelBDisplay].filter(c => c).join(' + ');
                    if (channels) {
                        salesDisplay = `<div>${sale.totalAmount.toLocaleString()} ฿</div>
                                       <div style="font-size: 0.8rem; opacity: 0.7;">${channels}</div>`;
                    }
                }
                
                // Basic columns that are always present
                const basicCols = `
                    <td>${formatDate(sale.date)}</td>
                    <td>${sale.numberCount} เบอร์</td>
                    <td>${salesDisplay}</td>
                `;
                
                // Dynamic columns based on phase
                let dynamicCols = '';
                
                if (hasPhase2) {
                    // If we have Phase 2 sales, show all 3 partner columns
                    if (sale.phase === 1) {
                        dynamicCols = `
                            <td>${(sale.aCapitalReturn || sale.shareA || 0).toLocaleString()} ฿</td>
                            <td>${(sale.shareB || 0).toLocaleString()} ฿</td>
                            <td>-</td>
                        `;
                    } else {
                        dynamicCols = `
                            <td>${(sale.shareA || 0).toLocaleString()} ฿</td>
                            <td>${(sale.shareB || 0).toLocaleString()} ฿</td>
                            <td>${(sale.shareC || 0).toLocaleString()} ฿</td>
                        `;
                    }
                } else {
                    // Phase 1 only display
                    dynamicCols = `
                        <td>${(sale.aCapitalReturn || sale.shareA || 0).toLocaleString()} ฿</td>
                        <td>${(sale.shareB || 0).toLocaleString()} ฿</td>
                    `;
                }
                
                // Action columns
                const actionCols = `
                    <td>Phase ${sale.phase}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-small btn-warning" onclick="editSale(${sale.id})">แก้ไข</button>
                            <button class="btn-small btn-danger" onclick="deleteSale(${sale.id})">ลบ</button>
                        </div>
                    </td>
                `;
                
                return `<tr>${basicCols}${dynamicCols}${actionCols}</tr>`;
            }).join('');
        }

        // Format date
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('th-TH', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        // Save settings
        function saveSettings(event) {
            event.preventDefault();
            
            const totalInvestment = parseFloat(document.getElementById('totalInvestment').value);
            const avgCost = parseFloat(document.getElementById('avgCost').value);
            
            appState.settings.totalInvestment = totalInvestment;
            appState.settings.avgCost = avgCost;
            
            // Calculate partner investments
            appState.settings.aCapitalAmount = totalInvestment * 0.7;
            appState.partners.A.invested = totalInvestment * 0.7;
            appState.partners.B.invested = totalInvestment * 0.3;
            appState.partners.C.invested = 0;
            
            saveData();
            updateDashboard();
            showToast('บันทึกการตั้งค่าสำเร็จ!', 'success');
        }

        // Edit partner name
        function editPartnerName(partner) {
            document.getElementById('modalTitle').textContent = 'แก้ไขชื่อหุ้นส่วน';
            
            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <div class="form-group">
                    <label>ชื่อใหม่</label>
                    <input type="text" id="editInput" value="${appState.partners[partner].name}" required>
                    <input type="hidden" id="editType" value="partner">
                    <input type="hidden" id="editId" value="${partner}">
                </div>
            `;
            
            document.getElementById('editModal').style.display = 'block';
        }

        // Edit sale - ฟังก์ชันแก้ไขที่สมบูรณ์
        function editSale(saleId) {
            const sale = appState.sales.find(s => s.id === saleId);
            if (!sale) return;
            
            document.getElementById('modalTitle').textContent = 'แก้ไขข้อมูลการขาย';
            
            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <div class="modal-form-row">
                    <div class="form-group">
                        <label>วันที่</label>
                        <input type="date" id="editSaleDate" value="${sale.date}" required>
                    </div>
                    <div class="form-group">
                        <label>จำนวนเบอร์</label>
                        <input type="number" id="editNumberCount" value="${sale.numberCount}" min="1" required>
                    </div>
                </div>
                <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <h4 style="margin-bottom: 10px; color: #ffd700;">💰 ยอดขายแยกตามช่องทาง</h4>
                    <div class="modal-form-row">
                        <div class="form-group">
                            <label>🔵 ช่องทาง ${appState.partners.A.name}</label>
                            <input type="number" id="editSalesChannelA" value="${sale.salesChannelA || sale.totalAmount || 0}" min="0" step="0.01" onchange="calculateEditTotal()">
                        </div>
                        <div class="form-group">
                            <label>🟢 ช่องทาง ${appState.partners.B.name}</label>
                            <input type="number" id="editSalesChannelB" value="${sale.salesChannelB || 0}" min="0" step="0.01" onchange="calculateEditTotal()">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>📊 ยอดขายรวม (บาท)</label>
                        <input type="number" id="editTotalAmount" value="${sale.totalAmount}" min="0" step="0.01" readonly style="background: rgba(255, 255, 255, 0.7); font-weight: bold;">
                    </div>
                </div>
                <div class="form-group">
                    <label>หมายเหตุ</label>
                    <textarea id="editSaleNote" rows="2">${sale.note || ''}</textarea>
                </div>
                <input type="hidden" id="editType" value="sale">
                <input type="hidden" id="editId" value="${saleId}">
            `;
            
            document.getElementById('editModal').style.display = 'block';
        }

        // Calculate total for edit form
        function calculateEditTotal() {
            const channelA = parseFloat(document.getElementById('editSalesChannelA').value) || 0;
            const channelB = parseFloat(document.getElementById('editSalesChannelB').value) || 0;
            const total = channelA + channelB;
            document.getElementById('editTotalAmount').value = total;
        }

        // Delete sale
        function deleteSale(saleId) {
            if (!confirm('ยืนยันการลบรายการนี้?')) return;
            
            const saleIndex = appState.sales.findIndex(s => s.id === saleId);
            if (saleIndex === -1) return;
            
            // Remove sale
            appState.sales.splice(saleIndex, 1);
            
            // Recalculate everything
            recalculateAll();
            
            saveData();
            updateDashboard();
            updateHistory();
            showToast('ลบรายการสำเร็จ!', 'success');
        }

        // Recalculate all shares
        function recalculateAll() {
            // Reset partner received amounts and capital
            appState.partners.A.received = 0;
            appState.partners.B.received = 0;
            appState.partners.C.received = 0;
            appState.settings.aCapitalReturned = 0;
            appState.phase = 1;
            
            // Sort sales by date to ensure correct phase calculation
            appState.sales.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Recalculate all sales in order
            appState.sales.forEach(sale => {
                // Recalculate costs
                sale.totalCost = sale.numberCount * appState.settings.avgCost;
                sale.profit = sale.totalAmount - sale.totalCost;
                
                // Update phase for this sale
                sale.phase = appState.phase;
                
                // Recalculate sharing
                const revenue = sale.totalAmount;
                
                if (appState.phase === 1) {
                    const shareA = revenue * 0.7;
                    const shareB = revenue * 0.3;
                    
                    appState.partners.A.received += shareA;
                    appState.partners.B.received += shareB;
                    
                    // Calculate capital return
                    const capitalBefore = appState.settings.aCapitalReturned;
                    const actualReturn = Math.min(shareA, appState.settings.aCapitalAmount - capitalBefore);
                    sale.aCapitalReturn = actualReturn;
                    
                    appState.settings.aCapitalReturned = Math.min(
                        appState.settings.aCapitalReturned + shareA,
                        appState.settings.aCapitalAmount
                    );
                    
                    // Check phase transition
                    if (appState.settings.aCapitalReturned >= appState.settings.aCapitalAmount) {
                        appState.phase = 2;
                    }
                    
                    sale.shareA = shareA;
                    sale.shareB = shareB;
                    sale.shareC = 0;
                } else {
                    const shareA = revenue * 0.5;
                    const shareB = revenue * 0.3;
                    const shareC = revenue * 0.2;
                    
                    appState.partners.A.received += shareA;
                    appState.partners.B.received += shareB;
                    appState.partners.C.received += shareC;
                    
                    sale.shareA = shareA;
                    sale.shareB = shareB;
                    sale.shareC = shareC;
                    sale.aCapitalReturn = 0;
                }
            });
        }

        // Save edit
        function saveEdit(event) {
            event.preventDefault();
            
            const type = document.getElementById('editType').value;
            const id = document.getElementById('editId').value;
            
            if (type === 'partner') {
                // Edit partner name
                const value = document.getElementById('editInput').value;
                appState.partners[id].name = value;
                updateDashboard();
                updateChannelNames(); // อัพเดทชื่อในฟอร์ม
                saveData();
                showToast('บันทึกการแก้ไขสำเร็จ!', 'success');
            } else if (type === 'sale') {
                // Edit sale
                const saleId = parseInt(id);
                const sale = appState.sales.find(s => s.id === saleId);
                
                if (sale) {
                    // Update sale data
                    sale.date = document.getElementById('editSaleDate').value;
                    sale.numberCount = parseInt(document.getElementById('editNumberCount').value);
                    sale.salesChannelA = parseFloat(document.getElementById('editSalesChannelA').value) || 0;
                    sale.salesChannelB = parseFloat(document.getElementById('editSalesChannelB').value) || 0;
                    sale.totalAmount = sale.salesChannelA + sale.salesChannelB;
                    sale.note = document.getElementById('editSaleNote').value;
                    
                    // Validate
                    if (sale.totalAmount <= 0) {
                        showToast('กรุณาใส่ยอดขายอย่างน้อย 1 ช่องทาง', 'error');
                        return;
                    }
                    
                    // Recalculate everything
                    recalculateAll();
                    
                    saveData();
                    updateDashboard();
                    updateHistory();
                    showToast('แก้ไขข้อมูลสำเร็จ!', 'success');
                }
            }
            
            closeModal();
        }

        // Close modal
        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        // Backup data
        function backupData() {
            const fileName = document.getElementById('backupFileName').value || 'phone-auction-backup';
            const dataStr = JSON.stringify(appState, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `${fileName}-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showToast('Backup สำเร็จ!', 'success');
        }

        // Restore data
        function restoreData() {
            const fileInput = document.getElementById('restoreFile');
            if (!fileInput.files.length) {
                showToast('กรุณาเลือกไฟล์', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    appState = data;
                    saveData();
                    updateDashboard();
                    showToast('Restore ข้อมูลสำเร็จ!', 'success');
                } catch (error) {
                    showToast('ไฟล์ไม่ถูกต้อง!', 'error');
                }
            };
            
            reader.readAsText(file);
        }

        // Export CSV
        function exportCSV() {
            let csv = '\ufeff'; // BOM for UTF-8
            csv += 'วันที่,จำนวนเบอร์,ช่องทาง ' + appState.partners.A.name + ',ช่องทาง ' + appState.partners.B.name + ',ยอดขายรวม,ต้นทุน,กำไร,Phase,';
            csv += appState.partners.A.name + ' ได้รับ,';
            csv += appState.partners.B.name + ' ได้รับ,';
            csv += appState.partners.C.name + ' ได้รับ,';
            csv += appState.partners.A.name + ' คืนทุน,หมายเหตุ\n';
            
            appState.sales.forEach(sale => {
                const shareA = sale.phase === 1 ? (sale.aCapitalReturn || sale.shareA || 0) : (sale.shareA || 0);
                const channelA = sale.salesChannelA || sale.totalAmount || 0;
                const channelB = sale.salesChannelB || 0;
                
                csv += `${sale.date},${sale.numberCount},${channelA},${channelB},${sale.totalAmount},`;
                csv += `${sale.totalCost},${sale.profit},Phase ${sale.phase},`;
                csv += `${shareA},${sale.shareB || 0},${sale.shareC || 0},`;
                csv += `${sale.aCapitalReturn || 0},"${sale.note || ''}"\n`;
            });
            
            // Add summary
            csv += '\n\nสรุป\n';
            csv += `${appState.partners.A.name} - ลงทุน:,${appState.partners.A.invested},ได้รับ:,${appState.partners.A.received},กำไร:,${appState.partners.A.received - appState.partners.A.invested}\n`;
            csv += `${appState.partners.B.name} - ลงทุน:,${appState.partners.B.invested},ได้รับ:,${appState.partners.B.received},กำไร:,${appState.partners.B.received - appState.partners.B.invested}\n`;
            csv += `${appState.partners.C.name} - ลงทุน:,${appState.partners.C.invested},ได้รับ:,${appState.partners.C.received},กำไร:,${appState.partners.C.received - appState.partners.C.invested}\n`;
            
            // Add channel summary
            csv += '\n\nสรุปยอดขายตามช่องทาง\n';
            const totalChannelA = appState.sales.reduce((sum, sale) => sum + (sale.salesChannelA || sale.totalAmount || 0), 0);
            const totalChannelB = appState.sales.reduce((sum, sale) => sum + (sale.salesChannelB || 0), 0);
            csv += `ช่องทาง ${appState.partners.A.name}:,${totalChannelA}\n`;
            csv += `ช่องทาง ${appState.partners.B.name}:,${totalChannelB}\n`;
            csv += `รวมทั้งหมด:,${totalChannelA + totalChannelB}\n`;
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `phone-sales-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showToast('Export CSV สำเร็จ!', 'success');
        }

        // Print report
        function printReport() {
            // Update print date
            document.getElementById('printDate').textContent = new Date().toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // Ensure history is updated before printing
            updateHistory();
            
            window.print();
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.style.display = 'block';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        // Save data to localStorage
        function saveData() {
            try {
                localStorage.setItem('phoneAuction2Phase', JSON.stringify(appState));
            } catch (e) {
                console.error('Error saving data:', e);
                showToast('เกิดข้อผิดพลาดในการบันทึกข้อมูล', 'error');
            }
        }

        // Load data from localStorage
        function loadData() {
            try {
                const saved = localStorage.getItem('phoneAuction2Phase');
                if (saved) {
                    const parsedData = JSON.parse(saved);
                    // Ensure all required fields exist
                    appState = {
                        ...appState,
                        ...parsedData,
                        settings: {
                            ...appState.settings,
                            ...parsedData.settings
                        },
                        partners: {
                            ...appState.partners,
                            ...parsedData.partners
                        }
                    };
                }
                
                // Load settings into form
                document.getElementById('totalInvestment').value = appState.settings.totalInvestment || '';
                document.getElementById('avgCost').value = appState.settings.avgCost || '';
            } catch (e) {
                console.error('Error loading data:', e);
                showToast('เกิดข้อผิดพลาดในการโหลดข้อมูล', 'error');
            }
        }

        // Handle window click for modal
        window.onclick = function(event) {
            const modal = document.getElementById('editModal');
            if (event.target == modal) {
                closeModal();
            }
        }

        // Error handling
        window.addEventListener('error', function(event) {
            console.error('Global error:', event.error);
            showToast('เกิดข้อผิดพลาด: ' + event.message, 'error');
        });
    </script>
</body>
</html>